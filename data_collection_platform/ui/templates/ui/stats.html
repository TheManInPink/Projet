<!-- ui/templates/ui/stats.html -->

<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Statistiques — OGSL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <style>
        .kpi-card { min-height: 100px; }
        .chart-card {
            padding: 1rem;
            height: clamp(220px, 35vh, 420px); /* s’adapte au viewport */
        }
        .chart-card.chart-sm {
            height: clamp(180px, 28vh, 360px); /* variante plus basse */
        }
        .table-fixed { table-layout: fixed; }
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            overflow: hidden;
        }

        /* Le canvas occupe 100% du conteneur chart-card */
        .chart-card > canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Utilitaire générique */
        .clamp {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            /* Standard d'abord */
            line-clamp: var(--lines, 2);
            /* Fallback WebKit */
            -webkit-line-clamp: var(--lines, 2);
        }
    </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">OGSL</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-sm btn-outline-primary" href="/swagger/"><i class="fa fa-book"></i> Swagger</a>
        <a class="btn btn-sm btn-outline-secondary" href="/graphql"><i class="fa fa-code"></i> GraphQL</a>
        <a class="btn btn-sm btn-success" href="/stats"><i class="fa fa-chart-line"></i> Stats</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card kpi-card shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="text-muted">Jeux de données</div>
              <div class="display-6 fw-bold">{{ total_datasets }}</div>
            </div>
            <i class="fa-solid fa-database fa-2x text-primary"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card kpi-card shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="text-muted">Sources</div>
              <div class="display-6 fw-bold">{{ total_sources }}</div>
            </div>
            <i class="fa-solid fa-sitemap fa-2x text-success"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card kpi-card shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="text-muted">Logs de moisson</div>
              <div class="display-6 fw-bold">{{ total_logs }}</div>
            </div>
            <i class="fa-solid fa-clipboard-list fa-2x text-warning"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphiques -->
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card shadow-sm chart-card">
                <h6 class="mb-3"><i class="fa fa-layer-group me-2"></i>Jeux par source</h6>
                <!-- <canvas id="chartBySource" height="160"></canvas> -->
                <canvas id="chartBySource"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm chart-card chart-sm"> 
                <h6 class="mb-3"><i class="fa fa-tags me-2"></i>Top mots-clés</h6>
                <!-- <canvas id="chartKeywords" height="160"></canvas> -->
                <canvas id="chartKeywords"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-lg-8">
            <div class="card shadow-sm chart-card">
                <h6 class="mb-3"><i class="fa fa-chart-line me-2"></i>Tendance des moissons (par mois)</h6>
                <canvas id="chartTrend"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm chart-card chart-sm">
                <h6 class="mb-3"><i class="fa fa-traffic-light me-2"></i>Statut des moissons</h6>
                <canvas id="chartStatus"></canvas>
            </div>
        </div>
    </div>

    <!-- Top organisations -->
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <h6 class="mb-3"><i class="fa fa-building me-2"></i>Top organisations (par nombre de jeux)</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle table-fixed">
            <thead>
              <tr><th style="width:70%">Organisation</th><th class="text-end">Jeux</th></tr>
            </thead>
            <tbody>
                {% for row in top_orgs %}
                <tr>
                    <td class="text-truncate-2">{{ row.organization|default:"—" }}</td>
                    <!-- <td class="clamp" style="--lines: 2;"> … </td> -->
                    <td class="text-end">{{ row.n }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="2" class="text-muted">Aucune donnée</td></tr>
                {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

    <!-- Données JSON sûres -->
    {{ source_labels|json_script:"src-labels" }}
    {{ source_values|json_script:"src-values" }}
    {{ kw_labels|json_script:"kw-labels" }}
    {{ kw_values|json_script:"kw-values" }}
    {{ trend_labels|json_script:"trend-labels" }}
    {{ trend_values|json_script:"trend-values" }}
    {{ status_labels|json_script:"status-labels" }}
    {{ status_values|json_script:"status-values" }}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
  <script>
    const srcLabels = JSON.parse(document.getElementById('src-labels').textContent);
    const srcValues = JSON.parse(document.getElementById('src-values').textContent);
    const kwLabels  = JSON.parse(document.getElementById('kw-labels').textContent);
    const kwValues  = JSON.parse(document.getElementById('kw-values').textContent);
    const trLabels  = JSON.parse(document.getElementById('trend-labels').textContent);
    const trValues  = JSON.parse(document.getElementById('trend-values').textContent);
    const stLabels  = JSON.parse(document.getElementById('status-labels').textContent);
    const stValues  = JSON.parse(document.getElementById('status-values').textContent);

    new Chart(document.getElementById('chartBySource'), {
      type: 'bar',
      data: { labels: srcLabels, datasets: [{ label: 'Jeux', data: srcValues }] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('chartKeywords'), {
      type: 'doughnut',
      data: { labels: kwLabels, datasets: [{ label: 'Occurrences', data: kwValues }] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('chartTrend'), {
      type: 'line',
      data: { labels: trLabels, datasets: [{ label: 'Jeux/mois', data: trValues, tension: 0.2, fill: false }] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('chartStatus'), {
      type: 'pie',
      data: { labels: stLabels, datasets: [{ label: 'Logs', data: stValues }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  </script>
</body>
</html>
